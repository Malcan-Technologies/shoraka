generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  user_id                  String                 @id @unique @db.VarChar(5)
  first_name               String
  last_name                String
  phone                    String?
  email                    String                 @unique
  cognito_sub              String                 @unique @db.VarChar(255)
  cognito_username         String                 @db.VarChar(255)
  investor_account         String[]               @default([])
  issuer_account           String[]               @default([])
  password_changed_at      DateTime?
  created_at               DateTime               @default(now())
  updated_at               DateTime               @updatedAt
  email_verified           Boolean                @default(false)
  roles                    UserRole[]
  access_logs              AccessLog[]
  sent_admin_invitations   AdminInvitation[]
  admin                    Admin?
  document_logs            DocumentLog[]
  investments              Investment[]
  investor_organizations   InvestorOrganization[]
  issuer_organizations     IssuerOrganization[]
  loans                    Loan[]
  onboarding_logs          OnboardingLog[]
  organization_memberships OrganizationMember[]
  regtank_onboarding       RegTankOnboarding[]
  security_logs            SecurityLog[]
  sessions                 UserSession[]

  @@index([cognito_sub])
  @@map("users")
}

model Loan {
  id              String       @id @default(cuid())
  borrower_id     String
  amount          Decimal      @db.Decimal(18, 6)
  interest_rate   Decimal      @db.Decimal(5, 2)
  duration_months Int
  purpose         String
  status          LoanStatus   @default(DRAFT)
  funded_amount   Decimal      @default(0) @db.Decimal(18, 6)
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt
  approved_at     DateTime?
  funded_at       DateTime?
  investments     Investment[]
  borrower        User         @relation(fields: [borrower_id], references: [user_id])

  @@map("loans")
}

model Investment {
  id          String   @id @default(cuid())
  investor_id String
  loan_id     String
  amount      Decimal  @db.Decimal(18, 6)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  investor    User     @relation(fields: [investor_id], references: [user_id])
  loan        Loan     @relation(fields: [loan_id], references: [id])

  @@map("investments")
}

model AccessLog {
  id            String   @id @default(cuid())
  user_id       String
  event_type    String
  ip_address    String?
  user_agent    String?
  device_info   String?
  cognito_event Json?
  success       Boolean  @default(true)
  metadata      Json?
  created_at    DateTime @default(now())
  device_type   String?
  portal        String?
  user          User     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([event_type])
  @@index([portal])
  @@index([created_at])
  @@index([user_id, created_at])
  @@map("access_logs")
}

model UserSession {
  id              String    @id @default(cuid())
  user_id         String
  cognito_session String    @unique @db.VarChar(512)
  ip_address      String?
  device_info     String?
  active_role     UserRole?
  last_activity   DateTime  @default(now())
  expires_at      DateTime
  revoked_at      DateTime?
  created_at      DateTime  @default(now())
  user            User      @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([cognito_session])
  @@index([expires_at])
  @@index([user_id, active_role])
  @@map("user_sessions")
}

model Admin {
  id               String    @id @default(cuid())
  user_id          String    @unique
  role_description AdminRole
  status           String    @default("ACTIVE")
  last_login       DateTime?
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt
  user             User      @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([status])
  @@map("admins")
}

model AdminInvitation {
  id                 String    @id @default(cuid())
  email              String
  role_description   AdminRole
  token              String    @unique
  expires_at         DateTime
  accepted           Boolean   @default(false)
  accepted_at        DateTime?
  invited_by_user_id String
  created_at         DateTime  @default(now())
  invited_by         User      @relation(fields: [invited_by_user_id], references: [user_id])

  @@index([email])
  @@index([token])
  @@index([expires_at])
  @@map("admin_invitations")
}

model SecurityLog {
  id          String   @id @default(cuid())
  user_id     String
  event_type  String
  ip_address  String?
  user_agent  String?
  device_info String?
  metadata    Json?
  created_at  DateTime @default(now())
  user        User     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([event_type])
  @@index([created_at])
  @@map("security_logs")
}

model OnboardingLog {
  id          String   @id @default(cuid())
  user_id     String
  role        UserRole
  event_type  String
  portal      String?
  ip_address  String?
  user_agent  String?
  device_info String?
  device_type String?
  metadata    Json?
  created_at  DateTime @default(now())
  user        User     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([role])
  @@index([event_type])
  @@index([portal])
  @@index([created_at])
  @@index([user_id, created_at])
  @@map("onboarding_logs")
}

model InvestorOrganization {
  id                            String               @id @default(cuid())
  owner_user_id                 String
  type                          OrganizationType
  name                          String?
  registration_number           String?
  onboarding_status             OnboardingStatus     @default(PENDING)
  onboarded_at                  DateTime?
  created_at                    DateTime             @default(now())
  updated_at                    DateTime             @updatedAt
  first_name                    String?
  last_name                     String?
  middle_name                   String?
  nationality                   String?
  country                       String?
  id_issuing_country            String?
  gender                        String?
  address                       String?
  date_of_birth                 DateTime?
  document_type                 String?
  document_number               String?
  phone_number                  String?
  kyc_id                        String?
  bank_account_details          Json?
  wealth_declaration            Json?
  compliance_declaration        Json?
  document_info                 Json?
  liveness_check_info           Json?
  is_sophisticated_investor     Boolean              @default(false)
  onboarding_approved           Boolean              @default(false)
  aml_approved                  Boolean              @default(false)
  tnc_accepted                  Boolean              @default(false)
  deposit_received              Boolean              @default(false)
  ssm_approved                  Boolean              @default(false)
  admin_approved_at             DateTime?
  kyc_response                  Json?
  sophisticated_investor_reason String?
  owner                         User                 @relation(fields: [owner_user_id], references: [user_id], onDelete: Cascade)
  members                       OrganizationMember[]
  regtank_onboarding            RegTankOnboarding[]  @relation("RegTankOnboardingToInvestorOrg")

  @@index([owner_user_id])
  @@index([owner_user_id, type])
  @@index([onboarding_status])
  @@map("investor_organizations")
}

model IssuerOrganization {
  id                     String               @id @default(cuid())
  owner_user_id          String
  type                   OrganizationType
  name                   String?
  registration_number    String?
  onboarding_status      OnboardingStatus     @default(PENDING)
  onboarded_at           DateTime?
  created_at             DateTime             @default(now())
  updated_at             DateTime             @updatedAt
  first_name             String?
  last_name              String?
  middle_name            String?
  nationality            String?
  country                String?
  id_issuing_country     String?
  gender                 String?
  address                String?
  date_of_birth          DateTime?
  document_type          String?
  document_number        String?
  phone_number           String?
  kyc_id                 String?
  bank_account_details   Json?
  wealth_declaration     Json?
  compliance_declaration Json?
  document_info          Json?
  liveness_check_info    Json?
  onboarding_approved    Boolean              @default(false)
  aml_approved           Boolean              @default(false)
  tnc_accepted           Boolean              @default(false)
  ssm_checked            Boolean              @default(false)
  admin_approved_at      DateTime?
  kyc_response           Json?
  owner                  User                 @relation(fields: [owner_user_id], references: [user_id], onDelete: Cascade)
  members                OrganizationMember[]
  regtank_onboarding     RegTankOnboarding[]  @relation("RegTankOnboardingToIssuerOrg")

  @@index([owner_user_id])
  @@index([owner_user_id, type])
  @@index([onboarding_status])
  @@map("issuer_organizations")
}

model OrganizationMember {
  id                       String                 @id @default(cuid())
  user_id                  String
  investor_organization_id String?
  issuer_organization_id   String?
  role                     OrganizationMemberRole
  created_at               DateTime               @default(now())
  investor_organization    InvestorOrganization?  @relation(fields: [investor_organization_id], references: [id], onDelete: Cascade)
  issuer_organization      IssuerOrganization?    @relation(fields: [issuer_organization_id], references: [id], onDelete: Cascade)
  user                     User                   @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@unique([user_id, investor_organization_id])
  @@unique([user_id, issuer_organization_id])
  @@index([user_id])
  @@index([investor_organization_id])
  @@index([issuer_organization_id])
  @@map("organization_members")
}

model RegTankOnboarding {
  id                       String                @id @default(cuid())
  user_id                  String
  investor_organization_id String?
  issuer_organization_id   String?
  organization_type        OrganizationType
  portal_type              String
  request_id               String                @unique
  reference_id             String                @unique
  onboarding_type          String
  verify_link              String?
  verify_link_expires_at   DateTime?
  status                   String
  substatus                String?
  regtank_response         Json?
  webhook_payloads         Json[]                @default([])
  created_at               DateTime              @default(now())
  updated_at               DateTime              @updatedAt
  submitted_at             DateTime?
  completed_at             DateTime?
  investor_organization    InvestorOrganization? @relation("RegTankOnboardingToInvestorOrg", fields: [investor_organization_id], references: [id], onDelete: Cascade)
  issuer_organization      IssuerOrganization?   @relation("RegTankOnboardingToIssuerOrg", fields: [issuer_organization_id], references: [id], onDelete: Cascade)
  user                     User                  @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([investor_organization_id])
  @@index([issuer_organization_id])
  @@index([request_id])
  @@index([reference_id])
  @@index([status])
  @@index([portal_type])
  @@map("regtank_onboarding")
}

model SiteDocument {
  id              String           @id @default(cuid())
  type            SiteDocumentType
  title           String
  description     String?
  file_name       String
  s3_key          String           @unique
  content_type    String
  file_size       Int
  version         Int              @default(1)
  is_active       Boolean          @default(true)
  show_in_account Boolean          @default(false)
  uploaded_by     String
  created_at      DateTime         @default(now())
  updated_at      DateTime         @updatedAt

  @@index([type, is_active])
  @@index([is_active, show_in_account])
  @@index([s3_key])
  @@map("site_documents")
}

model DocumentLog {
  id          String   @id @default(cuid())
  user_id     String
  document_id String?
  event_type  String
  ip_address  String?
  user_agent  String?
  device_info String?
  metadata    Json?
  created_at  DateTime @default(now())
  user        User     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([document_id])
  @@index([event_type])
  @@index([created_at])
  @@index([user_id, created_at])
  @@map("document_logs")
}

enum UserRole {
  INVESTOR
  ISSUER
  ADMIN
}

enum AdminRole {
  SUPER_ADMIN
  COMPLIANCE_OFFICER
  OPERATIONS_OFFICER
  FINANCE_OFFICER
}

enum LoanStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  FUNDED
  ACTIVE
  COMPLETED
  DEFAULTED
  REJECTED
}

enum OrganizationType {
  PERSONAL
  COMPANY
}

enum OnboardingStatus {
  PENDING
  COMPLETED
  IN_PROGRESS
  PENDING_APPROVAL
  PENDING_AML
  PENDING_SSM_REVIEW
  PENDING_FINAL_APPROVAL
  REJECTED
}

enum OrganizationMemberRole {
  OWNER
  DIRECTOR
  MEMBER
}

enum SiteDocumentType {
  TERMS_AND_CONDITIONS
  PRIVACY_POLICY
  RISK_DISCLOSURE
  PLATFORM_AGREEMENT
  INVESTOR_GUIDE
  ISSUER_GUIDE
  OTHER
}

// model Product {
//   id                    String   @id @default(cuid())
//   name                  String
//   description           String
//   image_url             String
//   required_documents    Json
//   declarations          Json?
//   max_financing_percent Decimal  @db.Decimal(5, 2)
//   min_profit_rate       Decimal  @db.Decimal(5, 2)
//   max_profit_rate       Decimal  @db.Decimal(5, 2)
//   created_at            DateTime @default(now())
//   updated_at            DateTime @updatedAt

//   @@map("products")
// }

model Product {
  id         String   @id @default(cuid())
  workflow   Json // Stores array of workflow steps: [{ id, name, enabled, config }]
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@map("products")
}
