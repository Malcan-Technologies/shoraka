generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  user_id                       String                           @id @unique @db.VarChar(5)
  first_name                    String
  last_name                     String
  phone                         String?
  email                         String                           @unique
  cognito_sub                   String                           @unique @db.VarChar(255)
  cognito_username              String                           @db.VarChar(255)
  investor_account              String[]                         @default([])
  issuer_account                String[]                         @default([])
  password_changed_at           DateTime?
  created_at                    DateTime                         @default(now())
  updated_at                    DateTime                         @updatedAt
  email_verified                Boolean                          @default(false)
  roles                         UserRole[]
  access_logs                   AccessLog[]
  sent_admin_invitations        AdminInvitation[]                @relation("SentAdminInvitations")
  admin                         Admin?
  document_logs                 DocumentLog[]
  investments                   Investment[]
  sent_investor_org_invitations InvestorOrganizationInvitation[] @relation("SentInvestorOrgInvitations")
  investor_organizations        InvestorOrganization[]
  sent_issuer_org_invitations   IssuerOrganizationInvitation[]   @relation("SentIssuerOrgInvitations")
  issuer_organizations          IssuerOrganization[]
  loans                         Loan[]
  onboarding_logs               OnboardingLog[]
  organization_memberships      OrganizationMember[]
  product_logs                  ProductLog[]
  regtank_onboarding            RegTankOnboarding[]
  security_logs                 SecurityLog[]
  sessions                      UserSession[]
  notifications                 Notification[]
  notification_preferences      UserNotificationPreference[]

  @@index([cognito_sub])
  @@map("users")
}

model Loan {
  id              String       @id @default(cuid())
  borrower_id     String
  amount          Decimal      @db.Decimal(18, 6)
  interest_rate   Decimal      @db.Decimal(5, 2)
  duration_months Int
  purpose         String
  status          LoanStatus   @default(DRAFT)
  funded_amount   Decimal      @default(0) @db.Decimal(18, 6)
  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt
  approved_at     DateTime?
  funded_at       DateTime?
  investments     Investment[]
  borrower        User         @relation(fields: [borrower_id], references: [user_id])

  @@map("loans")
}

model Investment {
  id          String   @id @default(cuid())
  investor_id String
  loan_id     String
  amount      Decimal  @db.Decimal(18, 6)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  investor    User     @relation(fields: [investor_id], references: [user_id])
  loan        Loan     @relation(fields: [loan_id], references: [id])

  @@map("investments")
}

model AccessLog {
  id            String   @id @default(cuid())
  user_id       String
  event_type    String
  ip_address    String?
  user_agent    String?
  device_info   String?
  cognito_event Json?
  success       Boolean  @default(true)
  metadata      Json?
  created_at    DateTime @default(now())
  device_type   String?
  portal        String?
  user          User     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([event_type])
  @@index([portal])
  @@index([created_at])
  @@index([user_id, created_at])
  @@map("access_logs")
}

model UserSession {
  id              String    @id @default(cuid())
  user_id         String
  cognito_session String    @unique @db.VarChar(512)
  ip_address      String?
  device_info     String?
  active_role     UserRole?
  last_activity   DateTime  @default(now())
  expires_at      DateTime
  revoked_at      DateTime?
  created_at      DateTime  @default(now())
  user            User      @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([cognito_session])
  @@index([expires_at])
  @@index([user_id, active_role])
  @@map("user_sessions")
}

model Admin {
  id               String    @id @default(cuid())
  user_id          String    @unique
  role_description AdminRole
  status           String    @default("ACTIVE")
  last_login       DateTime?
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt
  user             User      @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([status])
  @@map("admins")
}

model AdminInvitation {
  id                 String    @id @default(cuid())
  email              String
  role_description   AdminRole
  token              String    @unique
  expires_at         DateTime
  accepted           Boolean   @default(false)
  accepted_at        DateTime?
  invited_by_user_id String
  created_at         DateTime  @default(now())
  invited_by         User      @relation("SentAdminInvitations", fields: [invited_by_user_id], references: [user_id])

  @@index([email])
  @@index([token])
  @@index([expires_at])
  @@map("admin_invitations")
}

model SecurityLog {
  id          String   @id @default(cuid())
  user_id     String
  event_type  String
  ip_address  String?
  user_agent  String?
  device_info String?
  metadata    Json?
  created_at  DateTime @default(now())
  user        User     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([event_type])
  @@index([created_at])
  @@map("security_logs")
}

model OnboardingLog {
  id                       String                @id @default(cuid())
  user_id                  String
  organization_name        String?
  investor_organization_id String?
  issuer_organization_id   String?
  role                     UserRole
  event_type               String
  portal                   String?
  ip_address               String?
  user_agent               String?
  device_info              String?
  device_type              String?
  metadata                 Json?
  created_at               DateTime              @default(now())
  user                     User                  @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  investor_organization    InvestorOrganization? @relation(fields: [investor_organization_id], references: [id], onDelete: SetNull)
  issuer_organization      IssuerOrganization?   @relation(fields: [issuer_organization_id], references: [id], onDelete: SetNull)

  @@index([user_id])
  @@index([role])
  @@index([event_type])
  @@index([portal])
  @@index([created_at])
  @@index([user_id, created_at])
  @@index([organization_name])
  @@index([investor_organization_id])
  @@index([issuer_organization_id])
  @@map("onboarding_logs")
}

model InvestorOrganization {
  id                            String                           @id @default(cuid())
  owner_user_id                 String
  type                          OrganizationType
  name                          String?
  registration_number           String?
  onboarding_status             OnboardingStatus                 @default(PENDING)
  onboarded_at                  DateTime?
  created_at                    DateTime                         @default(now())
  updated_at                    DateTime                         @updatedAt
  first_name                    String?
  last_name                     String?
  middle_name                   String?
  nationality                   String?
  country                       String?
  id_issuing_country            String?
  gender                        String?
  address                       String?
  date_of_birth                 DateTime?
  document_type                 String?
  document_number               String?
  phone_number                  String?
  kyc_id                        String?
  bank_account_details          Json?
  wealth_declaration            Json?
  compliance_declaration        Json?
  document_info                 Json?
  liveness_check_info           Json?
  is_sophisticated_investor     Boolean                          @default(false)
  onboarding_approved           Boolean                          @default(false)
  aml_approved                  Boolean                          @default(false)
  tnc_accepted                  Boolean                          @default(false)
  deposit_received              Boolean                          @default(false)
  ssm_approved                  Boolean                          @default(false)
  admin_approved_at             DateTime?
  kyc_response                  Json?
  sophisticated_investor_reason String?
  corporate_entities            Json?
  corporate_onboarding_data     Json?
  corporate_required_documents  Json?
  director_aml_status           Json?
  director_kyc_status           Json?
  business_aml_status           Json?
  invitations                   InvestorOrganizationInvitation[]
  owner                         User                             @relation(fields: [owner_user_id], references: [user_id], onDelete: Cascade)
  members                       OrganizationMember[]
  regtank_onboarding            RegTankOnboarding[]              @relation("RegTankOnboardingToInvestorOrg")
  onboarding_logs               OnboardingLog[]

  @@index([owner_user_id])
  @@index([owner_user_id, type])
  @@index([onboarding_status])
  @@map("investor_organizations")
}

model IssuerOrganization {
  id                           String                         @id @default(cuid())
  owner_user_id                String
  type                         OrganizationType
  name                         String?
  registration_number          String?
  onboarding_status            OnboardingStatus               @default(PENDING)
  onboarded_at                 DateTime?
  created_at                   DateTime                       @default(now())
  updated_at                   DateTime                       @updatedAt
  first_name                   String?
  last_name                    String?
  middle_name                  String?
  nationality                  String?
  country                      String?
  id_issuing_country           String?
  gender                       String?
  address                      String?
  date_of_birth                DateTime?
  document_type                String?
  document_number              String?
  phone_number                 String?
  kyc_id                       String?
  bank_account_details         Json?
  wealth_declaration           Json?
  compliance_declaration       Json?
  document_info                Json?
  liveness_check_info          Json?
  onboarding_approved          Boolean                        @default(false)
  aml_approved                 Boolean                        @default(false)
  tnc_accepted                 Boolean                        @default(false)
  ssm_checked                  Boolean                        @default(false)
  admin_approved_at            DateTime?
  kyc_response                 Json?
  corporate_entities           Json?
  corporate_onboarding_data    Json?
  corporate_required_documents Json?
  director_aml_status          Json?
  director_kyc_status          Json?
  business_aml_status          Json?
  invitations                  IssuerOrganizationInvitation[]
  owner                        User                           @relation(fields: [owner_user_id], references: [user_id], onDelete: Cascade)
  members                      OrganizationMember[]
  regtank_onboarding           RegTankOnboarding[]            @relation("RegTankOnboardingToIssuerOrg")
  onboarding_logs              OnboardingLog[]

  @@index([owner_user_id])
  @@index([owner_user_id, type])
  @@index([onboarding_status])
  @@map("issuer_organizations")
}

model OrganizationMember {
  id                       String                 @id @default(cuid())
  user_id                  String
  investor_organization_id String?
  issuer_organization_id   String?
  role                     OrganizationMemberRole
  created_at               DateTime               @default(now())
  investor_organization    InvestorOrganization?  @relation(fields: [investor_organization_id], references: [id], onDelete: Cascade)
  issuer_organization      IssuerOrganization?    @relation(fields: [issuer_organization_id], references: [id], onDelete: Cascade)
  user                     User                   @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@unique([user_id, investor_organization_id])
  @@unique([user_id, issuer_organization_id])
  @@index([user_id])
  @@index([investor_organization_id])
  @@index([issuer_organization_id])
  @@map("organization_members")
}

model InvestorOrganizationInvitation {
  id                       String                 @id @default(cuid())
  email                    String
  role                     OrganizationMemberRole
  investor_organization_id String
  token                    String                 @unique
  expires_at               DateTime
  accepted                 Boolean                @default(false)
  accepted_at              DateTime?
  invited_by_user_id       String
  created_at               DateTime               @default(now())
  investor_organization    InvestorOrganization   @relation(fields: [investor_organization_id], references: [id], onDelete: Cascade)
  invited_by               User                   @relation("SentInvestorOrgInvitations", fields: [invited_by_user_id], references: [user_id], onDelete: Cascade)

  @@index([email])
  @@index([token])
  @@index([expires_at])
  @@index([investor_organization_id])
  @@map("investor_organization_invitation")
}

model IssuerOrganizationInvitation {
  id                     String                 @id @default(cuid())
  email                  String
  role                   OrganizationMemberRole
  issuer_organization_id String
  token                  String                 @unique
  expires_at             DateTime
  accepted               Boolean                @default(false)
  accepted_at            DateTime?
  invited_by_user_id     String
  created_at             DateTime               @default(now())
  invited_by             User                   @relation("SentIssuerOrgInvitations", fields: [invited_by_user_id], references: [user_id], onDelete: Cascade)
  issuer_organization    IssuerOrganization     @relation(fields: [issuer_organization_id], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([token])
  @@index([expires_at])
  @@index([issuer_organization_id])
  @@map("issuer_organization_invitation")
}

model RegTankOnboarding {
  id                       String                @id @default(cuid())
  user_id                  String
  investor_organization_id String?
  issuer_organization_id   String?
  organization_type        OrganizationType
  portal_type              String
  request_id               String                @unique
  reference_id             String                @unique
  onboarding_type          String
  verify_link              String?
  verify_link_expires_at   DateTime?
  status                   String
  substatus                String?
  regtank_response         Json?
  webhook_payloads         Json[]                @default([])
  created_at               DateTime              @default(now())
  updated_at               DateTime              @updatedAt
  submitted_at             DateTime?
  completed_at             DateTime?
  investor_organization    InvestorOrganization? @relation("RegTankOnboardingToInvestorOrg", fields: [investor_organization_id], references: [id], onDelete: Cascade)
  issuer_organization      IssuerOrganization?   @relation("RegTankOnboardingToIssuerOrg", fields: [issuer_organization_id], references: [id], onDelete: Cascade)
  user                     User                  @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([investor_organization_id])
  @@index([issuer_organization_id])
  @@index([request_id])
  @@index([reference_id])
  @@index([status])
  @@index([portal_type])
  @@map("regtank_onboarding")
}

model AmlIdentityMapping {
  id                String   @id @default(cuid())
  organization_id   String   @db.VarChar(255)
  organization_type String   // 'investor' | 'issuer'
  entity_type       String   // 'director' | 'individual_shareholder' | 'business_shareholder'
  
  // Identity fields for matching
  name              String?
  email             String?
  business_name     String? // For business shareholders
  
  // RegTank IDs
  cod_request_id    String? // Parent COD for individuals, own COD for businesses
  eod_request_id    String? // Only for directors/individual shareholders
  kyc_id            String? // For individuals
  kyb_id            String? // For businesses
  
  // Metadata
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  last_synced_at    DateTime?

  @@index([organization_id])
  @@index([kyc_id])
  @@index([kyb_id])
  @@index([cod_request_id])
  @@index([eod_request_id])
  @@index([organization_id, email])
  @@map("aml_identity_mapping")
}

model SiteDocument {
  id              String           @id @default(cuid())
  type            SiteDocumentType
  title           String
  description     String?
  file_name       String
  s3_key          String           @unique
  content_type    String
  file_size       Int
  version         Int              @default(1)
  is_active       Boolean          @default(true)
  show_in_account Boolean          @default(false)
  uploaded_by     String
  created_at      DateTime         @default(now())
  updated_at      DateTime         @updatedAt

  @@index([type, is_active])
  @@index([is_active, show_in_account])
  @@index([s3_key])
  @@map("site_documents")
}

model DocumentLog {
  id          String   @id @default(cuid())
  user_id     String
  document_id String?
  event_type  String
  ip_address  String?
  user_agent  String?
  device_info String?
  metadata    Json?
  created_at  DateTime @default(now())
  user        User     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([document_id])
  @@index([event_type])
  @@index([created_at])
  @@index([user_id, created_at])
  @@map("document_logs")
}

model ProductLog {
  id          String   @id @default(cuid())
  user_id     String
  product_id  String?
  event_type  String
  ip_address  String?
  user_agent  String?
  device_info String?
  metadata    Json?
  created_at  DateTime @default(now())
  user        User     @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id])
  @@index([product_id])
  @@index([event_type])
  @@index([created_at])
  @@index([user_id, created_at])
  @@map("product_logs")
}

model Product {
  id         String   @id @default(cuid())
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  workflow   Json

  @@map("products")
}

enum UserRole {
  INVESTOR
  ISSUER
  ADMIN
}

enum AdminRole {
  SUPER_ADMIN
  COMPLIANCE_OFFICER
  OPERATIONS_OFFICER
  FINANCE_OFFICER
}

enum LoanStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  FUNDED
  ACTIVE
  COMPLETED
  DEFAULTED
  REJECTED
}

enum OrganizationType {
  PERSONAL
  COMPANY
}

enum OnboardingStatus {
  PENDING
  COMPLETED
  IN_PROGRESS
  PENDING_APPROVAL
  PENDING_AML
  PENDING_SSM_REVIEW
  PENDING_FINAL_APPROVAL
  REJECTED
}

enum OrganizationMemberRole {
  OWNER
  DIRECTOR
  MEMBER
  ORGANIZATION_ADMIN
  ORGANIZATION_MEMBER
}

enum SiteDocumentType {
  TERMS_AND_CONDITIONS
  PRIVACY_POLICY
  RISK_DISCLOSURE
  PLATFORM_AGREEMENT
  INVESTOR_GUIDE
  ISSUER_GUIDE
  OTHER
}

enum NotificationCategory {
  AUTHENTICATION
  SYSTEM
  MARKETING
}

enum NotificationPriority {
  INFO
  WARNING
  CRITICAL
}

model NotificationType {
  id                String                     @id
  name              String
  description       String?
  category          NotificationCategory
  default_priority  NotificationPriority       @default(INFO)
  enabled_platform  Boolean                    @default(true)
  enabled_email     Boolean                    @default(true)
  user_configurable Boolean                    @default(true)
  retention_days    Int?
  created_at        DateTime                   @default(now())
  updated_at        DateTime                   @updatedAt
  notifications     Notification[]
  user_preferences  UserNotificationPreference[]

  @@map("notification_types")
}

model Notification {
  id                   String               @id @default(cuid())
  user_id              String
  notification_type_id String
  idempotency_key      String?              @unique
  priority             NotificationPriority
  title                String
  message              String
  read_at              DateTime?
  email_sent_at        DateTime?
  link_path            String?
  metadata             Json?
  created_at           DateTime             @default(now())
  expires_at           DateTime?
  user                 User                 @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  notification_type    NotificationType     @relation(fields: [notification_type_id], references: [id], onDelete: Cascade)

  @@index([user_id, created_at])
  @@index([user_id, read_at])
  @@index([notification_type_id])
  @@index([expires_at])
  @@index([idempotency_key])
  @@map("notifications")
}

model UserNotificationPreference {
  id                   String           @id @default(cuid())
  user_id              String
  notification_type_id String
  enabled_platform     Boolean
  enabled_email        Boolean
  created_at           DateTime         @default(now())
  updated_at           DateTime         @updatedAt
  user                 User             @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  notification_type    NotificationType @relation(fields: [notification_type_id], references: [id], onDelete: Cascade)

  @@unique([user_id, notification_type_id])
  @@index([user_id])
  @@map("user_notification_preferences")
}
