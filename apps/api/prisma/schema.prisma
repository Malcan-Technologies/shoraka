generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  INVESTOR
  ISSUER
  ADMIN
}

enum LoanStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  FUNDED
  ACTIVE
  COMPLETED
  DEFAULTED
  REJECTED
}

model User {
  id                              String     @id @default(cuid())
  email                           String     @unique
  cognito_sub                     String     @unique @db.VarChar(255)
  cognito_username                String     @db.VarChar(255)
  roles                           UserRole[]
  first_name                      String
  last_name                       String
  phone                           String?
  email_verified                  Boolean    @default(false)
  kyc_verified                    Boolean    @default(false)
  investor_onboarding_completed   Boolean    @default(false)
  issuer_onboarding_completed     Boolean    @default(false)
  password_changed_at             DateTime?
  created_at                      DateTime   @default(now())
  updated_at                      DateTime   @updatedAt

  loans          Loan[]
  investments    Investment[]
  access_logs    AccessLog[]
  sessions       UserSession[]
  refresh_tokens RefreshToken[]
  
  @@index([cognito_sub])
  @@map("users")
}

model Loan {
  id                String     @id @default(cuid())
  borrower_id       String
  amount            Decimal    @db.Decimal(18, 6)
  interest_rate     Decimal    @db.Decimal(5, 2)
  duration_months   Int
  purpose           String
  status            LoanStatus @default(DRAFT)
  funded_amount     Decimal    @default(0) @db.Decimal(18, 6)
  created_at        DateTime   @default(now())
  updated_at        DateTime   @updatedAt
  approved_at       DateTime?
  funded_at         DateTime?
  
  borrower     User         @relation(fields: [borrower_id], references: [id])
  investments  Investment[]
  
  @@map("loans")
}

model Investment {
  id          String   @id @default(cuid())
  investor_id String
  loan_id     String
  amount      Decimal  @db.Decimal(18, 6)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  
  investor User @relation(fields: [investor_id], references: [id])
  loan     Loan @relation(fields: [loan_id], references: [id])
  
  @@map("investments")
}

model AccessLog {
  id             String   @id @default(cuid())
  user_id        String
  event_type     String   // LOGIN, LOGOUT, SIGNUP, ROLE_ADDED, ROLE_SWITCHED, ONBOARDING_COMPLETED, ONBOARDING
  portal         String?  // "investor", "issuer", "admin"
  ip_address     String?
  user_agent     String?  @db.Text
  device_info    String?  // Detailed device info (e.g., "Chrome 120 on Windows 10")
  device_type    String?  // Simplified device type (e.g., "Windows Desktop", "iPhone")
  cognito_event  Json?
  success        Boolean  @default(true)
  metadata       Json?    // Stores active_role, auth_method, etc.
  created_at     DateTime @default(now())
  
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  @@index([user_id])
  @@index([event_type])
  @@index([portal])
  @@index([created_at])
  @@index([user_id, created_at])
  @@map("access_logs")
}

model UserSession {
  id               String    @id @default(cuid())
  user_id          String
  cognito_session  String    @unique @db.VarChar(512)
  ip_address       String?
  device_info      String?
  active_role      UserRole?
  last_activity    DateTime  @default(now())
  expires_at       DateTime
  revoked_at       DateTime?
  created_at       DateTime  @default(now())
  
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  @@index([user_id])
  @@index([cognito_session])
  @@index([expires_at])
  @@index([user_id, active_role])
  @@map("user_sessions")
}

model RefreshToken {
  id                 String    @id @default(cuid())
  token              String    @unique @db.VarChar(512)
  user_id            String
  
  // Security tracking
  device_fingerprint String?   @db.VarChar(255)
  ip_address         String?   @db.VarChar(45) // IPv6 max length
  user_agent         String?   @db.Text
  
  // Token lifecycle
  created_at         DateTime  @default(now())
  expires_at         DateTime
  used_at            DateTime? // When token was used for refresh
  used               Boolean   @default(false)
  revoked            Boolean   @default(false)
  revoked_at         DateTime?
  revoked_reason     String?   @db.VarChar(255)
  
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  @@index([user_id])
  @@index([token])
  @@index([user_id, revoked])
  @@index([expires_at])
  @@map("refresh_tokens")
}


