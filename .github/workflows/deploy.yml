name: Deploy All Services to ECR

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: ap-southeast-5

permissions:
  id-token: write # Required for OIDC
  contents: read

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for changes
        id: changes
        run: |
          if git diff --name-only HEAD^ HEAD | grep -qE '^apps/api/|^packages/(types|config)/'; then
            echo "api=true" >> $GITHUB_OUTPUT
          else
            echo "api=false" >> $GITHUB_OUTPUT
          fi

          if git diff --name-only HEAD^ HEAD | grep -qE '^apps/landing/|^packages/'; then
            echo "landing=true" >> $GITHUB_OUTPUT
          else
            echo "landing=false" >> $GITHUB_OUTPUT
          fi

          if git diff --name-only HEAD^ HEAD | grep -qE '^apps/investor/|^packages/'; then
            echo "investor=true" >> $GITHUB_OUTPUT
          else
            echo "investor=false" >> $GITHUB_OUTPUT
          fi

          if git diff --name-only HEAD^ HEAD | grep -qE '^apps/issuer/|^packages/'; then
            echo "issuer=true" >> $GITHUB_OUTPUT
          else
            echo "issuer=false" >> $GITHUB_OUTPUT
          fi

          if git diff --name-only HEAD^ HEAD | grep -qE '^apps/admin/|^packages/'; then
            echo "admin=true" >> $GITHUB_OUTPUT
          else
            echo "admin=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push API image
        if: steps.changes.outputs.api == 'true'
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: api-cashsouk
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -f docker/api.Dockerfile \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      - name: Build and push Landing image
        if: steps.changes.outputs.landing == 'true'
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: landing-cashsouk
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -f docker/landing.Dockerfile \
            --build-arg NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }} \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      - name: Build and push Investor image
        if: steps.changes.outputs.investor == 'true'
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: investor-cashsouk
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -f docker/portal-investor.Dockerfile \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      - name: Build and push Issuer image
        if: steps.changes.outputs.issuer == 'true'
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: issuer-cashsouk
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -f docker/portal-issuer.Dockerfile \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      - name: Build and push Admin image
        if: steps.changes.outputs.admin == 'true'
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: admin-cashsouk
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -f docker/portal-admin.Dockerfile \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      - name: Run Database Migrations
        if: steps.changes.outputs.api == 'true'
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          echo "üî® Building migration image..."
          docker build -f docker/migrate.Dockerfile -t migrate:${{ github.sha }} .

          echo "üì¶ Running migrations via ECS task..."

          # Get VPC config from existing API service
          VPC_CONFIG=$(aws ecs describe-services \
            --cluster default \
            --services api-cashsouk-09ff \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].networkConfiguration.awsvpcConfiguration' \
            --output json)

          SUBNETS=$(echo $VPC_CONFIG | jq -r '.subnets | join(",")')
          SECURITY_GROUPS=$(echo $VPC_CONFIG | jq -r '.securityGroups | join(",")')

          # Run migration as one-off ECS task
          TASK_ARN=$(aws ecs run-task \
            --cluster default \
            --launch-type FARGATE \
            --task-definition cashsouk-migrate \
            --network-configuration "awsvpcConfiguration={subnets=[$SUBNETS],securityGroups=[$SECURITY_GROUPS],assignPublicIp=DISABLED}" \
            --region ${{ env.AWS_REGION }} \
            --query 'tasks[0].taskArn' \
            --output text)

          echo "‚è≥ Waiting for migrations to complete (Task: $TASK_ARN)..."

          # Wait for task to complete
          aws ecs wait tasks-stopped \
            --cluster default \
            --tasks $TASK_ARN \
            --region ${{ env.AWS_REGION }}

          # Check exit code
          EXIT_CODE=$(aws ecs describe-tasks \
            --cluster default \
            --tasks $TASK_ARN \
            --region ${{ env.AWS_REGION }} \
            --query 'tasks[0].containers[0].exitCode' \
            --output text)

          if [ "$EXIT_CODE" != "0" ]; then
            echo "‚ùå Migrations failed with exit code $EXIT_CODE"
            
            # Get logs for debugging
            LOG_STREAM=$(aws ecs describe-tasks \
              --cluster default \
              --tasks $TASK_ARN \
              --region ${{ env.AWS_REGION }} \
              --query 'tasks[0].containers[0].name' \
              --output text)
            
            echo "üìã Migration logs:"
            aws logs tail /ecs/cashsouk-migrate --since 10m --region ${{ env.AWS_REGION }} || true
            
            exit 1
          fi

          echo "‚úÖ Migrations completed successfully"

      - name: Deploy API to ECS
        if: steps.changes.outputs.api == 'true'
        run: |
          aws ecs update-service \
            --cluster default \
            --service api-cashsouk-09ff \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Deploy Landing to ECS
        if: steps.changes.outputs.landing == 'true'
        run: |
          aws ecs update-service \
            --cluster default \
            --service landing-cashsouk-1156 \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Deploy Investor to ECS
        if: steps.changes.outputs.investor == 'true'
        run: |
          aws ecs update-service \
            --cluster default \
            --service investor-cashsouk-50e5 \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Deploy Issuer to ECS
        if: steps.changes.outputs.issuer == 'true'
        run: |
          aws ecs update-service \
            --cluster default \
            --service issuer-cashsouk-ff47 \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Deploy Admin to ECS
        if: steps.changes.outputs.admin == 'true'
        run: |
          aws ecs update-service \
            --cluster default \
            --service admin-cashsouk-7cd8 \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Deployment summary
        run: |
          echo "‚úÖ Deployment completed for services with changes"
          echo "Image tag: ${{ github.sha }}"
          echo ""
          echo "Services deployed:"
          if [ "${{ steps.changes.outputs.api }}" == "true" ]; then echo "  - API"; fi
          if [ "${{ steps.changes.outputs.landing }}" == "true" ]; then echo "  - Landing"; fi
          if [ "${{ steps.changes.outputs.investor }}" == "true" ]; then echo "  - Investor Portal"; fi
          if [ "${{ steps.changes.outputs.issuer }}" == "true" ]; then echo "  - Issuer Portal"; fi
          if [ "${{ steps.changes.outputs.admin }}" == "true" ]; then echo "  - Admin Portal"; fi
