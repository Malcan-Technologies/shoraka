name: Deploy All Services to ECR

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: ap-southeast-5

permissions:
  id-token: write
  contents: read

jobs:
  # ──────────────────────────────────────────────
  # 1. Detect which services have changes
  # ──────────────────────────────────────────────
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.changes.outputs.api }}
      migrations: ${{ steps.changes.outputs.migrations }}
      landing: ${{ steps.changes.outputs.landing }}
      investor: ${{ steps.changes.outputs.investor }}
      issuer: ${{ steps.changes.outputs.issuer }}
      admin: ${{ steps.changes.outputs.admin }}
      any_service: ${{ steps.changes.outputs.any_service }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for changes
        id: changes
        run: |
          if git rev-parse HEAD^ >/dev/null 2>&1; then
            COMPARE="HEAD^"
          else
            COMPARE="4b825dc642cb6eb9a060e54bf8d69288fbee4904"
          fi

          CHANGED=$(git diff --name-only $COMPARE HEAD)

          api=false; migrations=false; landing=false; investor=false; issuer=false; admin=false

          if echo "$CHANGED" | grep -qE '^apps/api/|^packages/(types|config)/|^docker/api\.Dockerfile'; then
            api=true
          fi
          if echo "$CHANGED" | grep -qE '^apps/api/prisma/(schema\.prisma|migrations/)'; then
            migrations=true
          fi
          if echo "$CHANGED" | grep -qE '^apps/landing/|^packages/|^docker/landing\.Dockerfile'; then
            landing=true
          fi
          if echo "$CHANGED" | grep -qE '^apps/investor/|^packages/|^docker/portal-investor\.Dockerfile'; then
            investor=true
          fi
          if echo "$CHANGED" | grep -qE '^apps/issuer/|^packages/|^docker/portal-issuer\.Dockerfile'; then
            issuer=true
          fi
          if echo "$CHANGED" | grep -qE '^apps/admin/|^packages/|^docker/portal-admin\.Dockerfile'; then
            admin=true
          fi

          any_service=false
          if [ "$api" = "true" ] || [ "$landing" = "true" ] || [ "$investor" = "true" ] || [ "$issuer" = "true" ] || [ "$admin" = "true" ]; then
            any_service=true
          fi

          echo "api=$api" >> $GITHUB_OUTPUT
          echo "migrations=$migrations" >> $GITHUB_OUTPUT
          echo "landing=$landing" >> $GITHUB_OUTPUT
          echo "investor=$investor" >> $GITHUB_OUTPUT
          echo "issuer=$issuer" >> $GITHUB_OUTPUT
          echo "admin=$admin" >> $GITHUB_OUTPUT
          echo "any_service=$any_service" >> $GITHUB_OUTPUT

          echo "Change detection results:"
          echo "  API: $api | Migrations: $migrations"
          echo "  Landing: $landing | Investor: $investor | Issuer: $issuer | Admin: $admin"

  # ──────────────────────────────────────────────
  # 2. API: Build -> Migrate -> Deploy (sequential)
  # ──────────────────────────────────────────────
  deploy-api:
    needs: detect-changes
    if: needs.detect-changes.outputs.api == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build API image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: api-cashsouk
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Building API image..."
          docker build -f docker/api.Dockerfile \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .

      - name: Build and push migration image
        if: needs.detect-changes.outputs.migrations == 'true'
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: cashsouk-migrate
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Building migration image..."
          docker build -f docker/migrate.Dockerfile \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .

          echo "Pushing migration image to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      - name: Run Database Migrations
        if: needs.detect-changes.outputs.migrations == 'true'
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          aws logs create-log-group \
            --log-group-name /ecs/cashsouk-migrate \
            --region ${{ env.AWS_REGION }} 2>/dev/null || true

          TASK_DEF=$(cat infra/ecs-task-definition-migrate.json | jq --arg IMAGE "$ECR_REGISTRY/cashsouk-migrate:$IMAGE_TAG" \
            '.containerDefinitions[0].image = $IMAGE')

          aws ecs register-task-definition \
            --cli-input-json "$TASK_DEF" \
            --region ${{ env.AWS_REGION }}

          TASK_ARN=$(aws ecs run-task \
            --cluster default \
            --launch-type FARGATE \
            --task-definition cashsouk-migrate \
            --network-configuration "awsvpcConfiguration={subnets=[subnet-0b0afc5315186d366,subnet-01ca25e9377340988,subnet-042e311cc1ee5ebdd],securityGroups=[sg-0f699f7ae290e3979],assignPublicIp=ENABLED}" \
            --region ${{ env.AWS_REGION }} \
            --query 'tasks[0].taskArn' \
            --output text)

          if [ -z "$TASK_ARN" ] || [ "$TASK_ARN" = "None" ]; then
            echo "Failed to start migration task"
            exit 1
          fi

          echo "Waiting for migrations to complete (Task: $TASK_ARN)..."

          aws ecs wait tasks-stopped \
            --cluster default \
            --tasks $TASK_ARN \
            --region ${{ env.AWS_REGION }}

          EXIT_CODE=$(aws ecs describe-tasks \
            --cluster default \
            --tasks $TASK_ARN \
            --region ${{ env.AWS_REGION }} \
            --query 'tasks[0].containers[0].exitCode' \
            --output text)

          if [ "$EXIT_CODE" != "0" ] && [ "$EXIT_CODE" != "None" ]; then
            echo "Migrations failed with exit code $EXIT_CODE"
            aws ecs describe-tasks \
              --cluster default \
              --tasks $TASK_ARN \
              --region ${{ env.AWS_REGION }} \
              --query 'tasks[0].containers[0]' || true
            TASK_ID=$(echo $TASK_ARN | awk -F'/' '{print $NF}')
            aws logs describe-log-streams \
              --log-group-name /ecs/cashsouk-migrate \
              --region ${{ env.AWS_REGION }} \
              --max-items 5 \
              --order-by LastEventTime \
              --descending || true
            aws logs tail /ecs/cashsouk-migrate \
              --since 15m \
              --format short \
              --region ${{ env.AWS_REGION }} || true
            exit 1
          elif [ "$EXIT_CODE" = "None" ]; then
            echo "Task stopped but exit code is None"
            aws ecs describe-tasks \
              --cluster default \
              --tasks $TASK_ARN \
              --region ${{ env.AWS_REGION }} \
              --query 'tasks[0]' || true
            exit 1
          fi

          echo "Migrations completed successfully"

      - name: Push and deploy API
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: api-cashsouk
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Pushing API image to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

          aws logs create-log-group --log-group-name /ecs/cashsouk-api --region ${{ env.AWS_REGION }} 2>/dev/null || true

          TEMPLATE=$(cat infra/ecs-task-definition-api.json)
          NEW_TASK_DEF=$(echo $TEMPLATE | jq --arg IMAGE "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" '
            .containerDefinitions[0].image = $IMAGE
          ')
          aws ecs register-task-definition --cli-input-json "$NEW_TASK_DEF" --region ${{ env.AWS_REGION }} > /dev/null

          aws ecs update-service \
            --cluster default \
            --service api-cashsouk-09ff \
            --task-definition default-api-cashsouk-09ff \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

          echo "API deployed successfully"

  # ──────────────────────────────────────────────
  # 3. Frontend services: Build -> Push -> Deploy (parallel)
  # ──────────────────────────────────────────────
  deploy-landing:
    needs: detect-changes
    if: needs.detect-changes.outputs.landing == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build push and deploy Landing
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: landing-cashsouk
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Building Landing image..."
          docker build -f docker/landing.Dockerfile \
            --build-arg NEXT_PUBLIC_COGNITO_USER_POOL_ID="${{ secrets.NEXT_PUBLIC_COGNITO_USER_POOL_ID }}" \
            --build-arg NEXT_PUBLIC_COGNITO_CLIENT_ID="${{ secrets.NEXT_PUBLIC_COGNITO_CLIENT_ID }}" \
            --build-arg NEXT_PUBLIC_COGNITO_DOMAIN="auth.cashsouk.com" \
            --build-arg NEXT_PUBLIC_COGNITO_REGION="${{ secrets.NEXT_PUBLIC_COGNITO_REGION }}" \
            --build-arg NEXT_PUBLIC_API_URL="${{ secrets.NEXT_PUBLIC_API_URL }}" \
            --build-arg NEXT_PUBLIC_INVESTOR_URL="https://investor.cashsouk.com" \
            --build-arg NEXT_PUBLIC_ISSUER_URL="https://issuer.cashsouk.com" \
            --build-arg NEXT_PUBLIC_ADMIN_URL="https://admin.cashsouk.com" \
            --build-arg NEXT_PUBLIC_LANDING_URL="https://cashsouk.com" \
            --build-arg NEXT_PUBLIC_COOKIE_DOMAIN=".cashsouk.com" \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .

          echo "Pushing Landing image to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

          aws logs create-log-group --log-group-name /ecs/cashsouk-landing --region ${{ env.AWS_REGION }} 2>/dev/null || true

          TEMPLATE=$(cat infra/ecs-task-definition-landing.json)
          NEW_TASK_DEF=$(echo $TEMPLATE | jq --arg IMAGE "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" '
            .containerDefinitions[0].image = $IMAGE
          ')
          aws ecs register-task-definition --cli-input-json "$NEW_TASK_DEF" --region ${{ env.AWS_REGION }} > /dev/null

          aws ecs update-service \
            --cluster default \
            --service landing-cashsouk-1156 \
            --task-definition default-landing-cashsouk-1156 \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

          echo "Landing deployed successfully"

  deploy-investor:
    needs: detect-changes
    if: needs.detect-changes.outputs.investor == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build push and deploy Investor
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: investor-cashsouk
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Building Investor image..."
          docker build -f docker/portal-investor.Dockerfile \
            --build-arg NEXT_PUBLIC_COGNITO_USER_POOL_ID="${{ secrets.NEXT_PUBLIC_COGNITO_USER_POOL_ID }}" \
            --build-arg NEXT_PUBLIC_COGNITO_CLIENT_ID="${{ secrets.NEXT_PUBLIC_COGNITO_CLIENT_ID }}" \
            --build-arg NEXT_PUBLIC_COGNITO_DOMAIN="auth.cashsouk.com" \
            --build-arg NEXT_PUBLIC_COGNITO_REGION="${{ secrets.NEXT_PUBLIC_COGNITO_REGION }}" \
            --build-arg NEXT_PUBLIC_API_URL="${{ secrets.NEXT_PUBLIC_API_URL }}" \
            --build-arg NEXT_PUBLIC_INVESTOR_URL="https://investor.cashsouk.com" \
            --build-arg NEXT_PUBLIC_ISSUER_URL="https://issuer.cashsouk.com" \
            --build-arg NEXT_PUBLIC_ADMIN_URL="https://admin.cashsouk.com" \
            --build-arg NEXT_PUBLIC_LANDING_URL="https://cashsouk.com" \
            --build-arg NEXT_PUBLIC_COOKIE_DOMAIN=".cashsouk.com" \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .

          echo "Pushing Investor image to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

          aws logs create-log-group --log-group-name /ecs/cashsouk-investor --region ${{ env.AWS_REGION }} 2>/dev/null || true

          TEMPLATE=$(cat infra/ecs-task-definition-investor.json)
          NEW_TASK_DEF=$(echo $TEMPLATE | jq --arg IMAGE "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" '
            .containerDefinitions[0].image = $IMAGE
          ')
          aws ecs register-task-definition --cli-input-json "$NEW_TASK_DEF" --region ${{ env.AWS_REGION }} > /dev/null

          aws ecs update-service \
            --cluster default \
            --service investor-cashsouk-50e5 \
            --task-definition default-investor-cashsouk-50e5 \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

          echo "Investor deployed successfully"

  deploy-issuer:
    needs: detect-changes
    if: needs.detect-changes.outputs.issuer == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build push and deploy Issuer
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: issuer-cashsouk
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Building Issuer image..."
          docker build -f docker/portal-issuer.Dockerfile \
            --build-arg NEXT_PUBLIC_COGNITO_USER_POOL_ID="${{ secrets.NEXT_PUBLIC_COGNITO_USER_POOL_ID }}" \
            --build-arg NEXT_PUBLIC_COGNITO_CLIENT_ID="${{ secrets.NEXT_PUBLIC_COGNITO_CLIENT_ID }}" \
            --build-arg NEXT_PUBLIC_COGNITO_DOMAIN="auth.cashsouk.com" \
            --build-arg NEXT_PUBLIC_COGNITO_REGION="${{ secrets.NEXT_PUBLIC_COGNITO_REGION }}" \
            --build-arg NEXT_PUBLIC_API_URL="${{ secrets.NEXT_PUBLIC_API_URL }}" \
            --build-arg NEXT_PUBLIC_INVESTOR_URL="https://investor.cashsouk.com" \
            --build-arg NEXT_PUBLIC_ISSUER_URL="https://issuer.cashsouk.com" \
            --build-arg NEXT_PUBLIC_ADMIN_URL="https://admin.cashsouk.com" \
            --build-arg NEXT_PUBLIC_LANDING_URL="https://cashsouk.com" \
            --build-arg NEXT_PUBLIC_COOKIE_DOMAIN=".cashsouk.com" \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .

          echo "Pushing Issuer image to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

          aws logs create-log-group --log-group-name /ecs/cashsouk-issuer --region ${{ env.AWS_REGION }} 2>/dev/null || true

          TEMPLATE=$(cat infra/ecs-task-definition-issuer.json)
          NEW_TASK_DEF=$(echo $TEMPLATE | jq --arg IMAGE "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" '
            .containerDefinitions[0].image = $IMAGE
          ')
          aws ecs register-task-definition --cli-input-json "$NEW_TASK_DEF" --region ${{ env.AWS_REGION }} > /dev/null

          aws ecs update-service \
            --cluster default \
            --service issuer-cashsouk-ff47 \
            --task-definition default-issuer-cashsouk-ff47 \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

          echo "Issuer deployed successfully"

  deploy-admin:
    needs: detect-changes
    if: needs.detect-changes.outputs.admin == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build push and deploy Admin
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: admin-cashsouk
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "Building Admin image..."
          docker build -f docker/portal-admin.Dockerfile \
            --build-arg NEXT_PUBLIC_COGNITO_USER_POOL_ID="${{ secrets.NEXT_PUBLIC_COGNITO_USER_POOL_ID }}" \
            --build-arg NEXT_PUBLIC_COGNITO_CLIENT_ID="${{ secrets.NEXT_PUBLIC_COGNITO_CLIENT_ID }}" \
            --build-arg NEXT_PUBLIC_COGNITO_DOMAIN="auth.cashsouk.com" \
            --build-arg NEXT_PUBLIC_COGNITO_REGION="${{ secrets.NEXT_PUBLIC_COGNITO_REGION }}" \
            --build-arg NEXT_PUBLIC_API_URL="${{ secrets.NEXT_PUBLIC_API_URL }}" \
            --build-arg NEXT_PUBLIC_INVESTOR_URL="https://investor.cashsouk.com" \
            --build-arg NEXT_PUBLIC_ISSUER_URL="https://issuer.cashsouk.com" \
            --build-arg NEXT_PUBLIC_ADMIN_URL="https://admin.cashsouk.com" \
            --build-arg NEXT_PUBLIC_LANDING_URL="https://cashsouk.com" \
            --build-arg NEXT_PUBLIC_COOKIE_DOMAIN=".cashsouk.com" \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .

          echo "Pushing Admin image to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

          aws logs create-log-group --log-group-name /ecs/cashsouk-admin --region ${{ env.AWS_REGION }} 2>/dev/null || true

          TEMPLATE=$(cat infra/ecs-task-definition-admin.json)
          NEW_TASK_DEF=$(echo $TEMPLATE | jq --arg IMAGE "$ECR_REGISTRY/admin-cashsouk:$IMAGE_TAG" '
            .family = "default-admin-cashsouk-544e" |
            .containerDefinitions[0].image = $IMAGE
          ')
          aws ecs register-task-definition --cli-input-json "$NEW_TASK_DEF" --region ${{ env.AWS_REGION }} > /dev/null

          aws ecs update-service \
            --cluster default \
            --service admin-cashsouk-544e \
            --task-definition default-admin-cashsouk-544e \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

          echo "Admin deployed successfully"

  # ──────────────────────────────────────────────
  # 4. Summary (waits for all parallel deploys)
  # ──────────────────────────────────────────────
  summary:
    needs: [detect-changes, deploy-api, deploy-landing, deploy-investor, deploy-issuer, deploy-admin]
    if: always() && needs.detect-changes.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Deployment summary
        env:
          API: ${{ needs.detect-changes.outputs.api }}
          LANDING: ${{ needs.detect-changes.outputs.landing }}
          INVESTOR: ${{ needs.detect-changes.outputs.investor }}
          ISSUER: ${{ needs.detect-changes.outputs.issuer }}
          ADMIN: ${{ needs.detect-changes.outputs.admin }}
          API_RESULT: ${{ needs.deploy-api.result }}
          LANDING_RESULT: ${{ needs.deploy-landing.result }}
          INVESTOR_RESULT: ${{ needs.deploy-investor.result }}
          ISSUER_RESULT: ${{ needs.deploy-issuer.result }}
          ADMIN_RESULT: ${{ needs.deploy-admin.result }}
        run: |
          echo "Deployment completed | Image tag: ${{ github.sha }}"
          echo ""
          echo "Service         | Changed | Result"
          echo "----------------|---------|-------"
          echo "API             | $API | $API_RESULT"
          echo "Landing         | $LANDING | $LANDING_RESULT"
          echo "Investor        | $INVESTOR | $INVESTOR_RESULT"
          echo "Issuer          | $ISSUER | $ISSUER_RESULT"
          echo "Admin           | $ADMIN | $ADMIN_RESULT"

          FAILED=false
          for result in "$API_RESULT" "$LANDING_RESULT" "$INVESTOR_RESULT" "$ISSUER_RESULT" "$ADMIN_RESULT"; do
            if [ "$result" = "failure" ]; then
              FAILED=true
            fi
          done

          if [ "$FAILED" = "true" ]; then
            echo ""
            echo "One or more deployments failed"
            exit 1
          fi
