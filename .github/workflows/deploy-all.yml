name: Deploy Selected Services

on:
  workflow_dispatch:
    inputs:
      deploy_api:
        description: "Deploy API"
        required: true
        type: boolean
        default: true
      deploy_landing:
        description: "Deploy Landing"
        required: true
        type: boolean
        default: true
      deploy_investor:
        description: "Deploy Investor Portal"
        required: true
        type: boolean
        default: true
      deploy_issuer:
        description: "Deploy Issuer Portal"
        required: true
        type: boolean
        default: true
      deploy_admin:
        description: "Deploy Admin Portal"
        required: true
        type: boolean
        default: true

env:
  AWS_REGION: ap-southeast-5

permissions:
  id-token: write # Required for OIDC
  contents: read

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # API: Build â†’ Migrate â†’ Push â†’ Deploy (immediately)
      - name: Build API image
        if: ${{ inputs.deploy_api }}
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: api-cashsouk
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ðŸ”¨ Building API image..."
          
          # Retry logic for Docker Hub outages
          max_attempts=3
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts..."
            
            if docker build -f docker/api.Dockerfile \
              -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .; then
              echo "âœ… Build successful!"
              break
            else
              if [ $attempt -eq $max_attempts ]; then
                echo "âŒ Build failed after $max_attempts attempts"
                exit 1
              fi
              
              echo "âš ï¸ Build failed, waiting 60 seconds before retry..."
              sleep 60
              attempt=$((attempt + 1))
            fi
          done

      - name: Check for migration changes
        id: migration_check
        if: ${{ inputs.deploy_api }}
        run: |
          # For manual deployment, always run migrations to be safe
          echo "migrations_changed=true" >> $GITHUB_OUTPUT

      - name: Build and push migration image
        if: ${{ inputs.deploy_api && steps.migration_check.outputs.migrations_changed == 'true' }}
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: cashsouk-migrate
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ðŸ”¨ Building migration image..."
          
          # Retry logic for Docker Hub outages
          max_attempts=3
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts..."
            
            if docker build -f docker/migrate.Dockerfile \
              -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .; then
              echo "âœ… Build successful!"
              break
            else
              if [ $attempt -eq $max_attempts ]; then
                echo "âŒ Build failed after $max_attempts attempts"
                exit 1
              fi
              
              echo "âš ï¸ Build failed, waiting 60 seconds before retry..."
              sleep 60
              attempt=$((attempt + 1))
            fi
          done

          echo "ðŸ“¦ Pushing migration image to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG || echo "âš ï¸ Image already exists, skipping push"

      - name: Run Database Migrations
        if: ${{ inputs.deploy_api && steps.migration_check.outputs.migrations_changed == 'true' }}
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ðŸ“ Ensuring CloudWatch log group exists..."
          aws logs create-log-group \
            --log-group-name /ecs/cashsouk-migrate \
            --region ${{ env.AWS_REGION }} 2>/dev/null || echo "Log group already exists"

          echo "ðŸ“¦ Registering migration task definition from template..."

          # Always use the template file to ensure latest configuration (secrets, roles, etc.)
          TASK_DEF=$(cat infra/ecs-task-definition-migrate.json | jq --arg IMAGE "$ECR_REGISTRY/cashsouk-migrate:$IMAGE_TAG" \
            '.containerDefinitions[0].image = $IMAGE')

          aws ecs register-task-definition \
            --cli-input-json "$TASK_DEF" \
            --region ${{ env.AWS_REGION }}

          echo "ðŸ“¦ Running migrations via ECS task..."

          # Run migration as one-off ECS task
          TASK_ARN=$(aws ecs run-task \
            --cluster default \
            --launch-type FARGATE \
            --task-definition cashsouk-migrate \
            --network-configuration "awsvpcConfiguration={subnets=[subnet-0b0afc5315186d366,subnet-01ca25e9377340988,subnet-042e311cc1ee5ebdd],securityGroups=[sg-0f699f7ae290e3979],assignPublicIp=ENABLED}" \
            --region ${{ env.AWS_REGION }} \
            --query 'tasks[0].taskArn' \
            --output text)

          if [ -z "$TASK_ARN" ] || [ "$TASK_ARN" = "None" ]; then
            echo "âŒ Failed to start migration task"
            exit 1
          fi

          echo "â³ Waiting for migrations to complete (Task: $TASK_ARN)..."

          # Wait for task to complete
          aws ecs wait tasks-stopped \
            --cluster default \
            --tasks $TASK_ARN \
            --region ${{ env.AWS_REGION }}

          # Check exit code
          EXIT_CODE=$(aws ecs describe-tasks \
            --cluster default \
            --tasks $TASK_ARN \
            --region ${{ env.AWS_REGION }} \
            --query 'tasks[0].containers[0].exitCode' \
            --output text)

          if [ "$EXIT_CODE" != "0" ] && [ "$EXIT_CODE" != "None" ]; then
            echo "âŒ Migrations failed with exit code $EXIT_CODE"
            
            # Get task details for debugging
            echo "ðŸ“‹ Task details:"
            aws ecs describe-tasks \
              --cluster default \
              --tasks $TASK_ARN \
              --region ${{ env.AWS_REGION }} \
              --query 'tasks[0].containers[0]' || true
            
            # Try to get logs using the task ID
            TASK_ID=$(echo $TASK_ARN | awk -F'/' '{print $NF}')
            echo "ðŸ“‹ Migration logs (Task ID: $TASK_ID):"
            
            # List log streams first to see what's available
            echo "Available log streams:"
            aws logs describe-log-streams \
              --log-group-name /ecs/cashsouk-migrate \
              --region ${{ env.AWS_REGION }} \
              --max-items 5 \
              --order-by LastEventTime \
              --descending || echo "Could not list log streams"
            
            # Try to tail logs
            aws logs tail /ecs/cashsouk-migrate \
              --since 15m \
              --format short \
              --region ${{ env.AWS_REGION }} || echo "Could not retrieve logs"
            
            exit 1
          elif [ "$EXIT_CODE" = "None" ]; then
            echo "âš ï¸ Task stopped but exit code is None - checking task status..."
            aws ecs describe-tasks \
              --cluster default \
              --tasks $TASK_ARN \
              --region ${{ env.AWS_REGION }} \
              --query 'tasks[0]' || true
            exit 1
          fi

          echo "âœ… Migrations completed successfully"

      - name: Push and deploy API
        if: ${{ inputs.deploy_api }}
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: api-cashsouk
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ðŸ“¦ Pushing API image to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG || echo "âš ï¸ Image already exists, skipping push"

          echo "ðŸ“ Ensuring CloudWatch log group exists..."
          aws logs create-log-group --log-group-name /ecs/cashsouk-api --region ${{ env.AWS_REGION }} 2>/dev/null || echo "Log group already exists"

          echo "ðŸ“ Updating task definition..."
          # Get the base template with all environment variables and secrets
          TEMPLATE=$(cat infra/ecs-task-definition-api.json)

          # Update only the image tag, keep secrets
          NEW_TASK_DEF=$(echo $TEMPLATE | jq --arg IMAGE "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" '
            .containerDefinitions[0].image = $IMAGE
          ')
          aws ecs register-task-definition --cli-input-json "$NEW_TASK_DEF" --region ${{ env.AWS_REGION }} > /dev/null

          echo "ðŸš€ Deploying API to ECS..."
          aws ecs update-service \
            --cluster default \
            --service api-cashsouk-09ff \
            --task-definition default-api-cashsouk-09ff \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

          echo "âœ… API deployed successfully"

      # Landing: Build â†’ Push â†’ Deploy (immediately)
      - name: Build push and deploy Landing
        if: ${{ inputs.deploy_landing }}
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: landing-cashsouk
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ðŸ”¨ Building Landing image..."
          
          # Retry logic for Docker Hub outages
          max_attempts=3
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts..."
            
            if docker build -f docker/landing.Dockerfile \
              -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .; then
              echo "âœ… Build successful!"
              break
            else
              if [ $attempt -eq $max_attempts ]; then
                echo "âŒ Build failed after $max_attempts attempts"
                exit 1
              fi
              
              echo "âš ï¸ Build failed, waiting 60 seconds before retry..."
              sleep 60
              attempt=$((attempt + 1))
            fi
          done

          echo "ðŸ“¦ Pushing Landing image to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG || echo "âš ï¸ Image already exists, skipping push"

          echo "ðŸ“ Ensuring CloudWatch log group exists..."
          aws logs create-log-group --log-group-name /ecs/cashsouk-landing --region ${{ env.AWS_REGION }} 2>/dev/null || echo "Log group already exists"

          echo "ðŸ“ Updating task definition..."
          TEMPLATE=$(cat infra/ecs-task-definition-landing.json)
          NEW_TASK_DEF=$(echo $TEMPLATE | jq --arg IMAGE "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" '
            .containerDefinitions[0].image = $IMAGE
          ')
          aws ecs register-task-definition --cli-input-json "$NEW_TASK_DEF" --region ${{ env.AWS_REGION }} > /dev/null

          echo "ðŸš€ Deploying Landing to ECS..."
          aws ecs update-service \
            --cluster default \
            --service landing-cashsouk-1156 \
            --task-definition default-landing-cashsouk-1156 \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

          echo "âœ… Landing deployed successfully"

      # Investor: Build â†’ Push â†’ Deploy (immediately)
      - name: Build push and deploy Investor
        if: ${{ inputs.deploy_investor }}
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: investor-cashsouk
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ðŸ”¨ Building Investor image..."
          
          # Retry logic for Docker Hub outages
          max_attempts=3
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts..."
            
            if docker build -f docker/portal-investor.Dockerfile \
              -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .; then
              echo "âœ… Build successful!"
              break
            else
              if [ $attempt -eq $max_attempts ]; then
                echo "âŒ Build failed after $max_attempts attempts"
                exit 1
              fi
              
              echo "âš ï¸ Build failed, waiting 60 seconds before retry..."
              sleep 60
              attempt=$((attempt + 1))
            fi
          done

          echo "ðŸ“¦ Pushing Investor image to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG || echo "âš ï¸ Image already exists, skipping push"

          echo "ðŸ“ Ensuring CloudWatch log group exists..."
          aws logs create-log-group --log-group-name /ecs/cashsouk-investor --region ${{ env.AWS_REGION }} 2>/dev/null || echo "Log group already exists"

          echo "ðŸ“ Updating task definition..."
          TEMPLATE=$(cat infra/ecs-task-definition-investor.json)
          NEW_TASK_DEF=$(echo $TEMPLATE | jq --arg IMAGE "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" '
            .containerDefinitions[0].image = $IMAGE
          ')
          aws ecs register-task-definition --cli-input-json "$NEW_TASK_DEF" --region ${{ env.AWS_REGION }} > /dev/null

          echo "ðŸš€ Deploying Investor to ECS..."
          aws ecs update-service \
            --cluster default \
            --service investor-cashsouk-50e5 \
            --task-definition default-investor-cashsouk-50e5 \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

          echo "âœ… Investor deployed successfully"

      # Issuer: Build â†’ Push â†’ Deploy (immediately)
      - name: Build push and deploy Issuer
        if: ${{ inputs.deploy_issuer }}
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: issuer-cashsouk
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ðŸ”¨ Building Issuer image..."
          
          # Retry logic for Docker Hub outages
          max_attempts=3
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts..."
            
            if docker build -f docker/portal-issuer.Dockerfile \
              -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .; then
              echo "âœ… Build successful!"
              break
            else
              if [ $attempt -eq $max_attempts ]; then
                echo "âŒ Build failed after $max_attempts attempts"
                exit 1
              fi
              
              echo "âš ï¸ Build failed, waiting 60 seconds before retry..."
              sleep 60
              attempt=$((attempt + 1))
            fi
          done

          echo "ðŸ“¦ Pushing Issuer image to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG || echo "âš ï¸ Image already exists, skipping push"

          echo "ðŸ“ Ensuring CloudWatch log group exists..."
          aws logs create-log-group --log-group-name /ecs/cashsouk-issuer --region ${{ env.AWS_REGION }} 2>/dev/null || echo "Log group already exists"

          echo "ðŸ“ Updating task definition..."
          TEMPLATE=$(cat infra/ecs-task-definition-issuer.json)
          NEW_TASK_DEF=$(echo $TEMPLATE | jq --arg IMAGE "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" '
            .containerDefinitions[0].image = $IMAGE
          ')
          aws ecs register-task-definition --cli-input-json "$NEW_TASK_DEF" --region ${{ env.AWS_REGION }} > /dev/null

          echo "ðŸš€ Deploying Issuer to ECS..."
          aws ecs update-service \
            --cluster default \
            --service issuer-cashsouk-ff47 \
            --task-definition default-issuer-cashsouk-ff47 \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

          echo "âœ… Issuer deployed successfully"

      # Admin: Build â†’ Push â†’ Deploy (immediately)
      - name: Build push and deploy Admin
        if: ${{ inputs.deploy_admin }}
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: admin-cashsouk
          IMAGE_TAG: ${{ github.sha }}
        run: |
          echo "ðŸ”¨ Building Admin image..."
          
          # Retry logic for Docker Hub outages
          max_attempts=3
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "Attempt $attempt of $max_attempts..."
            
            if docker build -f docker/portal-admin.Dockerfile \
              -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .; then
              echo "âœ… Build successful!"
              break
            else
              if [ $attempt -eq $max_attempts ]; then
                echo "âŒ Build failed after $max_attempts attempts"
                exit 1
              fi
              
              echo "âš ï¸ Build failed, waiting 60 seconds before retry..."
              sleep 60
              attempt=$((attempt + 1))
            fi
          done

          echo "ðŸ“¦ Pushing Admin image to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG || echo "âš ï¸ Image already exists, skipping push"

          echo "ðŸ“ Ensuring CloudWatch log group exists..."
          aws logs create-log-group --log-group-name /ecs/cashsouk-admin --region ${{ env.AWS_REGION }} 2>/dev/null || echo "Log group already exists"

          echo "ðŸ“ Updating task definition..."
          TEMPLATE=$(cat infra/ecs-task-definition-admin.json)
          NEW_TASK_DEF=$(echo $TEMPLATE | jq --arg IMAGE "$ECR_REGISTRY/admin-cashsouk:$IMAGE_TAG" '
            .family = "default-admin-cashsouk-544e" |
            .containerDefinitions[0].image = $IMAGE
          ')
          aws ecs register-task-definition --cli-input-json "$NEW_TASK_DEF" --region ${{ env.AWS_REGION }} > /dev/null

          echo "ðŸš€ Deploying Admin to ECS..."
          aws ecs update-service \
            --cluster default \
            --service admin-cashsouk-544e \
            --task-definition default-admin-cashsouk-544e \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

          echo "âœ… Admin deployed successfully"

      - name: Deployment summary
        run: |
          echo "âœ… Deployment completed"
          echo "Image tag: ${{ github.sha }}"
          echo ""
          echo "Services deployed:"
          if [ "${{ inputs.deploy_api }}" == "true" ]; then echo "  - API"; fi
          if [ "${{ inputs.deploy_landing }}" == "true" ]; then echo "  - Landing"; fi
          if [ "${{ inputs.deploy_investor }}" == "true" ]; then echo "  - Investor Portal"; fi
          if [ "${{ inputs.deploy_issuer }}" == "true" ]; then echo "  - Issuer Portal"; fi
          if [ "${{ inputs.deploy_admin }}" == "true" ]; then echo "  - Admin Portal"; fi
